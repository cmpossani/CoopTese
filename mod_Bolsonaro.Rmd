---
title: "Decomposição de Desempenho das Cooperativas de Crédito Brasileiras - Análise de Regressões Multinível"
subtitle: "Janelas temporais estão baseadas nos períodos de governo"
author: "Cleverton Marlon Possani"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Carregando pacotes necessários
library(lme4)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)  # Para organizar os gráficos lado a lado

```

# **Introdução**


## **Justificativa das *Janelas Temporais**
A escolha das janelas temporais baseadas nos períodos presidenciais foi feita para capturar as mudanças políticas, econômicas e sociais que ocorreram durante cada mandato, uma vez que essas mudanças podem ter impactos significativos no desempenho das cooperativas de crédito no Brasil. Cada presidência trouxe diferentes políticas econômicas, reformas e crises, o que justifica a divisão por mandatos presidenciais.



**1995–1998: Fernando Henrique Cardoso (1º Mandato:**
O primeiro mandato de Fernando Henrique Cardoso foi marcado pela consolidação do Plano Real, que trouxe a estabilização econômica e a redução da hiperinflação. As reformas econômicas e a estabilização da moeda tiveram um impacto profundo no setor financeiro, incluindo as cooperativas de crédito, que passaram a operar em um ambiente econômico mais estável, porém desafiado pela necessidade de adaptação ao novo contexto de controle da inflação e juros elevados.

**1999–2002: Fernando Henrique Cardoso (2º Mandato:**
No segundo mandato de FHC, o Brasil enfrentou crises econômicas internacionais, como a crise russa (1998) e a crise asiática (1997). A política de câmbio fixo foi abandonada em 1999, o que trouxe impactos ao sistema financeiro e uma flutuação no ambiente econômico. As cooperativas de crédito, neste período, precisaram lidar com taxas de juros voláteis, ajustes fiscais e incertezas econômicas. As reformas estruturais, como a privatização de empresas estatais, também contribuíram para mudanças significativas no cenário econômico.

**2003–2006: Luiz Inácio Lula da Silva (1º Mandato):**
O primeiro mandato de Luiz Inácio Lula da Silva foi caracterizado por um forte compromisso com a responsabilidade fiscal e a continuidade das políticas econômicas iniciadas por FHC. No entanto, houve uma maior ênfase em programas sociais e em políticas de crédito e financiamento voltadas para setores mais pobres. O crescimento econômico, impulsionado pelo aumento das exportações e a melhoria dos preços das commodities, beneficiou as cooperativas de crédito, que viram o aumento da inclusão financeira e o fortalecimento do crédito rural.

**2007–2010: Luiz Inácio Lula da Silva (2º Mandato):**
Durante o segundo mandato de Lula, o Brasil enfrentou a crise financeira global de 2008. O governo adotou políticas anticíclicas, como a expansão do crédito, redução de impostos e programas de estímulo ao consumo interno. As cooperativas de crédito desempenharam um papel crucial na manutenção do crédito em áreas rurais e menos favorecidas, se beneficiando do cenário de recuperação econômica pós-crise e da expansão do crédito promovida pelo governo.

**2011–2014: Dilma Rousseff (1º Mandato):**
O primeiro mandato de Dilma Rousseff foi marcado por uma série de intervenções governamentais na economia, como a redução forçada das taxas de juros pelos bancos públicos e a tentativa de controlar a inflação via medidas de controle de preços (como no setor energético). Embora o Brasil tenha mantido um crescimento modesto nos primeiros anos, a economia começou a desacelerar em 2013 e 2014, com o aumento da inflação e das taxas de juros. As cooperativas de crédito enfrentaram dificuldades em um cenário de crescimento econômico cada vez mais baixo.

**2015–2016: Dilma Rousseff (2º Mandato):**
O segundo mandato de Dilma Rousseff foi marcado pela pior recessão econômica em décadas, agravada pela crise política e econômica que culminou no processo de impeachment. As cooperativas de crédito, assim como outras instituições financeiras, enfrentaram um ambiente econômico altamente adverso, com aumento da inadimplência e queda na demanda por crédito. O período foi curto (apenas dois anos), mas crucial, pois refletiu o impacto das políticas governamentais no setor financeiro.

**2016–2018: Michel Temer:**
Durante o governo de Michel Temer, o Brasil passou por reformas importantes, como a reforma trabalhista e o controle dos gastos públicos com a PEC do teto de gastos. O governo implementou políticas para restaurar a confiança do mercado, focando na estabilização econômica e no controle da inflação. Embora tenha sido um período de transição, com um mandato relativamente curto, o impacto dessas reformas e do ajuste fiscal no sistema financeiro foi significativo, afetando as cooperativas de crédito que operavam em um ambiente econômico mais controlado e com juros mais baixos.

**2019–2022: Jair Bolsonaro:**
O mandato de Jair Bolsonaro foi caracterizado por uma série de reformas econômicas, como a reforma da Previdência, e um forte impulso na agenda de privatizações e desregulamentação do mercado. Durante o período da pandemia de COVID-19, o governo implementou medidas emergenciais de apoio financeiro, como o auxílio emergencial, e houve uma expansão do crédito para empresas e famílias. As cooperativas de crédito desempenharam um papel importante em fornecer suporte às pequenas empresas e ao agronegócio durante esse período desafiador, mas também precisaram se adaptar ao novo cenário de incerteza global.

---

# **Resumo estatístico das Janelas Temporais:**
```{r, estatisticas_janelas, echo=FALSE}
# Exibir a tabela de estatísticas no relatório
estatisticas_totais

```

-
```{r, estatisticas1_janelas_graficas, echo=FALSE}

# Gráfico de barras comparando a média por janela temporal
ggplot(estatisticas_totais, aes(x = Janela, y = Media, fill = Janela)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparação da Média de SOBRAS_POR_ATIVO por Janela Temporal",
       x = "Janela Temporal", y = "Média de SOBRAS_POR_ATIVO") +
  theme_minimal()

```

### Análise:

> O gráfico revela variações significativas no desempenho das cooperativas de crédito ao longo dos diferentes mandatos presidenciais. 

> Os períodos FHC2 e Lula2 foram marcados por desempenhos mais negativos, enquanto os períodos de Bolsonaro, Dilma2, e Temer apresentam médias de desempenho mais próximas de zero, sugerindo uma recuperação ou estabilidade relativa. Esses resultados podem refletir as políticas econômicas e as condições macroeconômicas que afetaram as cooperativas durante cada mandato. 

---


```{r, estatisticas2_janelas_graficas, echo=FALSE}
# Gráfico de barras comparando a mediana por janela temporal
ggplot(estatisticas_totais, aes(x = Janela, y = Mediana, fill = Janela)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparação da Mediana de SOBRAS_POR_ATIVO por Janela Temporal",
       x = "Janela Temporal", y = "Mediana de SOBRAS_POR_ATIVO") +
  theme_minimal()

```

### Análise:

> O gráfico demonstra que o desempenho das cooperativas de crédito, medido pela mediana de SOBRAS_POR_ATIVO, foi mais forte no primeiro mandato de FHC1, com uma queda gradual a partir de FHC2, seguida por estabilidade em níveis mais baixos durante os governos Dilma, Lula2 e Bolsonaro. 

> Esses resultados sugerem que, embora o período de FHC1 tenha sido excepcionalmente favorável, houve uma tendência de redução no desempenho mediano das cooperativas ao longo dos anos, com alguns períodos de recuperação, como observado durante o governo Temer.

---

```{r, estatisticas3_janelas_graficas, echo=FALSE}
# Gráfico de barras comparando o desvio padrão por janela temporal
ggplot(estatisticas_totais, aes(x = Janela, y = Desvio_Padrao, fill = Janela)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparação do Desvio Padrão de SOBRAS_POR_ATIVO por Janela Temporal",
       x = "Janela Temporal", y = "Desvio Padrão de SOBRAS_POR_ATIVO") +
  theme_minimal()


```

### Análise:

> FHC1 foi o período com maior variabilidade, sugerindo uma dispersão significativa no desempenho das cooperativas de crédito, com algumas obtendo resultados extremamente bons e outras com resultados muito fracos. 

> Dilma2 e Temer foram os períodos com menor variabilidade, indicando uma maior uniformidade no desempenho das cooperativas de crédito. O desvio padrão intermediário observado nos períodos de Bolsonaro, Dilma1, e Lula indica que, nesses períodos, o desempenho das cooperativas variou moderadamente.

---

### **Comparação das médias de SOBRAS_POR_ATIVO por ano dentro de cada janela temporal**
```{r, janelasANO, echo=FALSE}

ggplot(estatisticas_totais_ano, aes(x = ANO, y = Media, group = Janela, color = Janela)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(title = "Comparação da Média de SOBRAS_POR_ATIVO por Ano e Janela Temporal",
       x = "Ano", y = "Média de SOBRAS_POR_ATIVO") +
  theme_minimal() +
  scale_x_continuous(breaks = estatisticas_totais_ano$ANO) +  # Exibir todos os anos no eixo X
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Análise:

> FHC1 e FHC2 foram períodos de alta volatilidade e desempenho negativo das cooperativas de crédito, com flutuações significativas ano a ano.

> Lula1 e Lula2 indicam uma fase de recuperação, embora o desempenho ainda tenha permanecido instável.

> Dilma1, Dilma2, e Temer mostraram uma clara estabilização, com o desempenho das cooperativas ficando mais uniforme e próximo de zero.

> Bolsonaro continuou essa tendência de estabilidade, com pouca variação no desempenho médio até 2022, quando uma leve queda começa a surgir.


```{r, janelasANO1, echo=FALSE}
# Gráfico de barras agrupadas comparando a mediana de SOBRAS_POR_ATIVO por ano
ggplot(estatisticas_totais_ano, aes(x = factor(ANO), y = Mediana, fill = Janela)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Comparação da Mediana de SOBRAS_POR_ATIVO por Ano e Janela Temporal",
       x = "Ano", y = "Mediana de SOBRAS_POR_ATIVO") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# Análise:

> A mediana de SOBRAS_POR_ATIVO revela uma trajetória de declínio mais gradual e estável ao longo dos mandatos presidenciais, especialmente a partir de Lula1. A queda inicial observada em FHC2 foi seguida de um período de maior estabilidade, com as cooperativas de crédito mantendo um desempenho relativamente constante durante Dilma, Temer, e Bolsonaro, mesmo que em níveis mais baixos do que em FHC1.

> A mediana, ao ser menos influenciada por valores extremos, sugere que a maioria das cooperativas conseguiu manter um desempenho estável nos últimos mandatos, apesar dos desafios econômicos que podem ter afetado algumas instituições de forma mais severa.

```{r, echo=FALSE}
ggplot(estatisticas_totais, aes(x = Janela)) +
  geom_point(aes(y = Media, color = "Média"), size = 3) +
  geom_point(aes(y = Mediana, color = "Mediana"), size = 3) +
  geom_point(aes(y = Desvio_Padrao, color = "Desvio Padrão"), size = 3) +
  labs(title = "Comparação das Estatísticas de SOBRAS_POR_ATIVO por Janela Temporal",
       x = "Janela Temporal", y = "Valores Estatísticos") +
  theme_minimal() +
  scale_color_manual(values = c("Média" = "blue", "Mediana" = "green", "Desvio Padrão" = "red"))
```

# Análise:

> O gráfico revela que o período de maior volatilidade e desafios para as cooperativas foi durante os mandatos de Fernando Henrique Cardoso, especialmente no primeiro mandato. Houve uma melhora relativa na estabilidade e na homogeneidade do desempenho durante os governos de Dilma e Temer. No entanto, mesmo durante esses períodos de estabilidade, o desempenho médio das cooperativas continuou a ser negativo



# **Início da análise das Regressões da Janela Bolsonaro (2019 - 2022)**
```{r df_Bolsonaro, include=TRUE}


mod_Bolsonaro <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Bolsonaro)
```

#**Erro de Ajuste Singular:**
Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular').

##**Explicação:**
Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero. 

##**Solução:**
Aplicar método de tratamento de outliers por sua capacidade de influenciar significativamente as estimativas de variância.

```{r, echo=FALSE }
# Criando os dois boxplots
p1 <- ggplot(df_Bolsonaro, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_Zscore[,c(1,2,8)])


#Visão geral das distribuições, valores ausentes, contagens de categorias e estatísticas descritivas básicas.
#summary(df_Bolsonaro)

resultadosB <- remover_outliers_zscore(df_Bolsonaro, "SOBRAS_POR_ATIVO")
df_sem_outliers_Zscore <- resultadosB$df_sem_outliers
df_com_outliers_Zscore <- resultadosB$df_com_outliers




#Visão geral das distribuições, valores ausentes, contagens de categorias e estatísticas descritivas básicas após z-Score.
#summary(df_sem_outliers_Zscore)



```

### Algumas estatísticas descritivas da base

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=8}
# Carregar o pacote
library(skimr)
library(naniar)

vis_miss(df_final2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Usar skim para obter o resumo e filtrar apenas variáveis categóricas
result <- skim(df_sem_outliers_Zscore)

# Filtrar os resultados para mostrar apenas variáveis categóricas
result_categorico <- dplyr::filter(result, skim_type == "factor")

# Mostrar o resultado
print(result_categorico)

```



##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatistica, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_Zscore, "Bolsonaro (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Bolsonaro <- capture.output(summary(df_Bolsonaro))
summary_sem_outliers <- capture.output(summary(df_sem_outliers_Zscore))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Bolsonaro, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliers, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
# Carregar a biblioteca necessária
library(ggplot2)
library(gridExtra)

# Gráfico 1: Contagem por Localização Município
p1 <- ggplot(df_sem_outliers_Zscore, aes(x = factor(Localizacao_munic))) +
  geom_bar() +
  labs(title = "Contagem por Localização Município", x = "Município", y = "Contagem") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal()

# Gráfico 2: Contagem por Estado (UF)
p2 <- ggplot(df_sem_outliers_Zscore, aes(x = factor(Localizacao_UF))) +
  geom_bar() +
  labs(title = "Contagem por Estado (UF)", x = "Estado (UF)", y = "Contagem") +
  theme_minimal()

# Gráfico 3: Contagem por Localização Imediata
p3 <- ggplot(df_sem_outliers_Zscore, aes(x = factor(Localizacao_Imed))) +
  geom_bar() +
  labs(title = "Contagem por Localização Imediata", x = "Localização Imediata", y = "Contagem") +
  theme_minimal()

# Gráfico 4: Contagem por Localização Intermediária
p4 <- ggplot(df_sem_outliers_Zscore, aes(x = factor(Localizacao_Inter))) +
  geom_bar() +
  labs(title = "Contagem por Localização Intermediária", x = "Localização Intermediária", y = "Contagem") +
  theme_minimal()

# Organizar os gráficos em uma tabela 2x2
grid.arrange(p1, p2, p3, p4, ncol = 2)

```

---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r}
mod_Bolsonaro_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_Zscore)
summary(mod_Bolsonaro_UF)

mod_Bolsonaro_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_Zscore)
summary(mod_Bolsonaro_Inter)

mod_Bolsonaro_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_Zscore)
summary(mod_Bolsonaro_Imed)

mod_Bolsonaro_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_Zscore)
summary(mod_Bolsonaro_Munic)

```

```{r, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Bolsonaro_UF)
plot_Inter <- plot_pizza_2D(mod_Bolsonaro_Inter)
plot_Imed <- plot_pizza_2D(mod_Bolsonaro_Imed)
plot_Munic <- plot_pizza_2D(mod_Bolsonaro_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Bolsonaro (2019 - 2022)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Bolsonaro_UF, mod_Bolsonaro_Inter, mod_Bolsonaro_Imed, mod_Bolsonaro_Munic)
names <- c("Bolsonaro UF", "Bolsonaro Inter", "Bolsonaro Imed", "Bolsonaro Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Bolsonaro UF", "Bolsonaro Inter", "Bolsonaro Imed", "Bolsonaro Munic"),
  AIC = c(AIC(mod_Bolsonaro_UF), AIC(mod_Bolsonaro_Inter), AIC(mod_Bolsonaro_Imed), AIC(mod_Bolsonaro_Munic)),
  BIC = c(BIC(mod_Bolsonaro_UF), BIC(mod_Bolsonaro_Inter), BIC(mod_Bolsonaro_Imed), BIC(mod_Bolsonaro_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Bolsonaro (2019 - 2022)**

Dado que o foco da pesquisa está na influência da localização, os resultados desta janela temporal sugerem que a localização em nível UF (estadual) é a que mais influencia o desempenho das cooperativas de crédito, contribuindo com 3,5% da variância. Isso pode estar relacionado às políticas públicas estaduais, características econômicas e sociais de cada estado, que podem influenciar a performance das cooperativas de crédito de maneira mais significativa do que as variações em níveis mais locais, como município e regiões intermediárias ou imediatas.
 

<!-- ```{r, echo=FALSE} -->
<!-- # Gerar gráficos de resíduos para cada modelo -->
<!-- par(mfrow = c(2, 2))  # Configura a visualização 2x2 -->
<!-- plot(residuals(mod_Bolsonaro_UF), main = "Resíduos - Bolsonaro UF") -->
<!-- plot(residuals(mod_Bolsonaro_Inter), main = "Resíduos - Bolsonaro Inter") -->
<!-- plot(residuals(mod_Bolsonaro_Imed), main = "Resíduos - Bolsonaro Imed") -->
<!-- plot(residuals(mod_Bolsonaro_Munic), main = "Resíduos - Bolsonaro Munic") -->

<!-- ``` -->

---

---

# **Início da análise das Regressões da Janela Temer (2017 - 2018)**
```{r df_Temer, include=TRUE}


mod_Temer <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Temer)
```

#**Erro de Ajuste Singular:**
Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular').

##**Explicação:**
Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero. 

##**Solução:**
Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados.


mod_Temer <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Temer)
summary(mod_Temer)


```{r, echo=FALSE }
# Criando os dois boxplots
p1 <- ggplot(df_Temer, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreT, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreT[,c(1,2,9)])


#Visão geral das distribuições, valores ausentes, contagens de categorias e estatísticas descritivas básicas.
#summary(df_Bolsonaro)

resultadosT <- remover_outliers_zscore(df_Temer, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreT <- resultadosT$df_sem_outliers
df_com_outliers_ZscoreT <- resultadosT$df_com_outliers


#Visão geral das distribuições, valores ausentes, contagens de categorias e estatísticas descritivas básicas após z-Score.
#summary(df_sem_outliers_Zscore)



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaTemer, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreT, "Temer (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Temer <- capture.output(summary(df_Temer))
summary_sem_outliersT <- capture.output(summary(df_sem_outliers_ZscoreT))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Temer, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersT, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 2 níveis (1 - Unidade de Negócio; 2 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r Temer, echo=TRUE}
mod_Temer_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF), data = df_sem_outliers_ZscoreT)
summary(mod_Temer_UF)

mod_Temer_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter), data = df_sem_outliers_ZscoreT)
summary(mod_Temer_Inter)

mod_Temer_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed), data = df_sem_outliers_ZscoreT)
summary(mod_Temer_Imed)

mod_Temer_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_sem_outliers_ZscoreT)
summary(mod_Temer_Munic)

```

```{r TemerPlot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Temer_UF)
plot_Inter <- plot_pizza_2D(mod_Temer_Inter)
plot_Imed <- plot_pizza_2D(mod_Temer_Imed)
plot_Munic <- plot_pizza_2D(mod_Temer_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Temer (2017 - 2018)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r TemerModels, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Temer_UF, mod_Temer_Inter, mod_Temer_Imed, mod_Temer_Munic)
names <- c("Temer UF", "Temer Inter", "Temer Imed", "Temer Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r TemerIAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Temer UF", "Temer Inter", "Temer Imed", "Temer Munic"),
  AIC = c(AIC(mod_Temer_UF), AIC(mod_Temer_Inter), AIC(mod_Temer_Imed), AIC(mod_Temer_Munic)),
  BIC = c(BIC(mod_Temer_UF), BIC(mod_Temer_Inter), BIC(mod_Temer_Imed), BIC(mod_Temer_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Temer (2017 - 2018)**

Embora as características internas das cooperativas (Unidade de Negócio) continuem sendo o fator mais importante para explicar o desempenho, a Localizacao_UF (4,3%) foi o nível de localização com maior contribuição, sugerindo que as políticas estaduais, o ambiente econômico e as condições regionais de cada estado tiveram um impacto considerável no desempenho das cooperativas de crédito. A Localizacao_Munic (3,3%) também apresentou alguma relevância, indicando que as características do município onde as cooperativas estão inseridas podem ter desempenhado um papel menor, mas ainda significativo, no desempenho.

 

<!-- ```{r, echo=FALSE} -->
<!-- # Gerar gráficos de resíduos para cada modelo -->
<!-- par(mfrow = c(2, 2))  # Configura a visualização 2x2 -->
<!-- plot(residuals(mod_Bolsonaro_UF), main = "Resíduos - Bolsonaro UF") -->
<!-- plot(residuals(mod_Bolsonaro_Inter), main = "Resíduos - Bolsonaro Inter") -->
<!-- plot(residuals(mod_Bolsonaro_Imed), main = "Resíduos - Bolsonaro Imed") -->
<!-- plot(residuals(mod_Bolsonaro_Munic), main = "Resíduos - Bolsonaro Munic") -->

<!-- ``` -->

---

---

# **Início da análise das Regressões da Janela Dilma 2 (2015 - 2016)**
```{r df_Dilma2, include=TRUE}


mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Dilma2)
```

#**Erro de Ajuste Singular:**
Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular').

##**Explicação:**
Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero. 

##**Solução:**
Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados.


mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Dilma2)
summary(mod_Dilma2)


```{r, echo=FALSE }
# Criando os dois boxplots
p1 <- ggplot(df_Dilma2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreD2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreD2[,c(1,2,8)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaDilma2, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreD2, "Dilma2 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Dilma2 <- capture.output(summary(df_Dilma2))
summary_sem_outliersD2 <- capture.output(summary(df_sem_outliers_ZscoreD2))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Dilma2, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersD2, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 2 níveis (1 - Unidade de Negócio; 2 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r Dilma2, echo=TRUE}
mod_Dilma2_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF), data = df_sem_outliers_ZscoreD2)
summary(mod_Dilma2_UF)

mod_Dilma2_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter), data = df_sem_outliers_ZscoreD2)
summary(mod_Dilma2_Inter)

mod_Dilma2_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed), data = df_sem_outliers_ZscoreD2)
summary(mod_Dilma2_Imed)

mod_Dilma2_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_sem_outliers_ZscoreD2)
summary(mod_Dilma2_Munic)

```

```{r Dilma2Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Dilma2_UF)
plot_Inter <- plot_pizza_2D(mod_Dilma2_Inter)
plot_Imed <- plot_pizza_2D(mod_Dilma2_Imed)
plot_Munic <- plot_pizza_2D(mod_Dilma2_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Dilma2 (2015 - 2016)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r Dilma2Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Dilma2_UF, mod_Dilma2_Inter, mod_Dilma2_Imed, mod_Dilma2_Munic)
names <- c("Dilma2 UF", "Dilma2 Inter", "Dilma2 Imed", "Dilma2 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r Dilma2IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Dilma2 UF", "Dilma2 Inter", "Dilma2 Imed", "Dilma2 Munic"),
  AIC = c(AIC(mod_Dilma2_UF), AIC(mod_Dilma2_Inter), AIC(mod_Dilma2_Imed), AIC(mod_Dilma2_Munic)),
  BIC = c(BIC(mod_Dilma2_UF), BIC(mod_Dilma2_Inter), BIC(mod_Dilma2_Imed), BIC(mod_Dilma2_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Dilma 2 (2015 - 2016)**

Diferente de outras janelas, o modelo de Localizacao_Inter (10,7%) foi o que mais contribuiu para explicar a variabilidade do desempenho das cooperativas de crédito. Esse resultado sugere que as características regionais intermediárias desempenham um papel mais importante durante o período de 2015-2016, superando até mesmo a influência da Localizacao_UF (6,6%). Isso pode ser um reflexo de condições regionais específicas que afetam a competitividade e o desempenho das cooperativas nesse período.
 

<!-- ```{r, echo=FALSE} -->
<!-- # Gerar gráficos de resíduos para cada modelo -->
<!-- par(mfrow = c(2, 2))  # Configura a visualização 2x2 -->
<!-- plot(residuals(mod_Bolsonaro_UF), main = "Resíduos - Bolsonaro UF") -->
<!-- plot(residuals(mod_Bolsonaro_Inter), main = "Resíduos - Bolsonaro Inter") -->
<!-- plot(residuals(mod_Bolsonaro_Imed), main = "Resíduos - Bolsonaro Imed") -->
<!-- plot(residuals(mod_Bolsonaro_Munic), main = "Resíduos - Bolsonaro Munic") -->

<!-- ``` -->

---

---

# **Início da análise das Regressões da Janela Dilma 1 (2011 - 2014)**
```{r df_Dilma1, include=TRUE}


mod_Dilma1 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Dilma1)
```

<!-- #**Erro de Ajuste Singular:** -->
<!-- Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular'). -->

<!-- ##**Explicação:** -->
<!-- Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero.  -->

<!-- ##**Solução:** -->
<!-- Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados. -->


<!-- mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Dilma2) -->
<!-- summary(mod_Dilma2) -->


```{r, echo=FALSE }

resultadosD1 <- remover_outliers_zscore(df_Dilma1, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreD1 <- resultadosD1$df_sem_outliers
df_com_outliers_ZscoreD1 <- resultadosD1$df_com_outliers
# Criando os dois boxplots
p1 <- ggplot(df_Dilma1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreD1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreD1[,c(1,2,9)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaDilma1, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreD1, "Dilma1 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Dilma1 <- capture.output(summary(df_Dilma1))
summary_sem_outliersD1 <- capture.output(summary(df_sem_outliers_ZscoreD1))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Dilma1, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersD1, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r Dilma1, echo=TRUE}
mod_Dilma1_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_ZscoreD1)
summary(mod_Dilma1_UF)

mod_Dilma1_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_ZscoreD1)
summary(mod_Dilma1_Inter)

mod_Dilma1_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_ZscoreD1)
summary(mod_Dilma1_Imed)

mod_Dilma1_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_ZscoreD1)
summary(mod_Dilma1_Munic)

```

```{r Dilma1Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Dilma1_UF)
plot_Inter <- plot_pizza_2D(mod_Dilma1_Inter)
plot_Imed <- plot_pizza_2D(mod_Dilma1_Imed)
plot_Munic <- plot_pizza_2D(mod_Dilma1_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Dilma1 (2011 - 2014)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r Dilma1Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Dilma1_UF, mod_Dilma1_Inter, mod_Dilma1_Imed, mod_Dilma1_Munic)
names <- c("Dilma1 UF", "Dilma1 Inter", "Dilma1 Imed", "Dilma1 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r Dilma1IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Dilma1 UF", "Dilma1 Inter", "Dilma1 Imed", "Dilma1 Munic"),
  AIC = c(AIC(mod_Dilma1_UF), AIC(mod_Dilma1_Inter), AIC(mod_Dilma1_Imed), AIC(mod_Dilma1_Munic)),
  BIC = c(BIC(mod_Dilma1_UF), BIC(mod_Dilma1_Inter), BIC(mod_Dilma1_Imed), BIC(mod_Dilma1_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Dilma 1 (2011 - 2014)**

Na janela Dilma1 (2011-2014), a Localizacao_munic (5,2%) foi a que apresentou maior impacto sobre o desempenho das cooperativas, indicando que fatores locais específicos ao nível municipal influenciaram significativamente as cooperativas nesse período. No entanto, a contribuição da Unidade_de_Negocio (mais de 75%) continua sendo o fator dominante.
 

<!-- ```{r, echo=FALSE} -->
<!-- # Gerar gráficos de resíduos para cada modelo -->
<!-- par(mfrow = c(2, 2))  # Configura a visualização 2x2 -->
<!-- plot(residuals(mod_Bolsonaro_UF), main = "Resíduos - Bolsonaro UF") -->
<!-- plot(residuals(mod_Bolsonaro_Inter), main = "Resíduos - Bolsonaro Inter") -->
<!-- plot(residuals(mod_Bolsonaro_Imed), main = "Resíduos - Bolsonaro Imed") -->
<!-- plot(residuals(mod_Bolsonaro_Munic), main = "Resíduos - Bolsonaro Munic") -->

<!-- ``` -->

---

---

# **Início da análise das Regressões da Janela Lula 2 (2006 - 2010)**
```{r df_Lula2, include=TRUE}


mod_Lula2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Lula2)
```

<!-- #**Erro de Ajuste Singular:** -->
<!-- Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular'). -->

<!-- ##**Explicação:** -->
<!-- Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero.  -->

<!-- ##**Solução:** -->
<!-- Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados. -->


<!-- mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Dilma2) -->
<!-- summary(mod_Dilma2) -->


```{r, echo=FALSE }

resultadosL2 <- remover_outliers_zscore(df_Lula2, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreL2 <- resultadosL2$df_sem_outliers
df_com_outliers_ZscoreL2 <- resultadosL2$df_com_outliers
# Criando os dois boxplots
p1 <- ggplot(df_Lula2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreL2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreL2[,c(1,2,9)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaLula2, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreL2, "Lula2 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Lula2 <- capture.output(summary(df_Lula2))
summary_sem_outliersL2 <- capture.output(summary(df_sem_outliers_ZscoreL2))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Lula2, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersL2, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r Lula2, echo=TRUE}
mod_Lula2_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_ZscoreL2)
summary(mod_Lula2_UF)

mod_Lula2_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_ZscoreL2)
summary(mod_Lula2_Inter)

mod_Lula2_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_ZscoreL2)
summary(mod_Lula2_Imed)

mod_Lula2_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_ZscoreL2)
summary(mod_Lula2_Munic)

```

```{r Lula2Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Lula2_UF)
plot_Inter <- plot_pizza_2D(mod_Lula2_Inter)
plot_Imed <- plot_pizza_2D(mod_Lula2_Imed)
plot_Munic <- plot_pizza_2D(mod_Lula2_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Lula2 (2006 - 2010)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r Lula2Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Lula2_UF, mod_Lula2_Inter, mod_Lula2_Imed, mod_Lula2_Munic)
names <- c("Lula2 UF", "Lula2 Inter", "Lula2 Imed", "Lula2 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r Lula2IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Lula2 UF", "Lula2 Inter", "Lula2 Imed", "Lula2 Munic"),
  AIC = c(AIC(mod_Lula2_UF), AIC(mod_Lula2_Inter), AIC(mod_Lula2_Imed), AIC(mod_Lula2_Munic)),
  BIC = c(BIC(mod_Lula2_UF), BIC(mod_Lula2_Inter), BIC(mod_Lula2_Imed), BIC(mod_Lula2_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Lula 2 (2006 - 2010)**

Na janela Lula2 (2006-2010), a Localizacao_UF (6,1%) destacou-se como a que teve maior influência no desempenho das cooperativas, apontando que as condições estaduais exerceram maior impacto em comparação aos níveis de localização municipal e regional. No entanto, o fator Unidade_de_Negocio continua sendo o mais relevante, sugerindo que a influência interna das cooperativas supera a influência externa da localização.


---

---

# **Início da análise das Regressões da Janela Lula 1 (2002 - 2005)**
```{r df_Lula1, include=TRUE}


mod_Lula1 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_Lula1)
```

<!-- #**Erro de Ajuste Singular:** -->
<!-- Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular'). -->

<!-- ##**Explicação:** -->
<!-- Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero.  -->

<!-- ##**Solução:** -->
<!-- Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados. -->


<!-- mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Dilma2) -->
<!-- summary(mod_Dilma2) -->


```{r, echo=FALSE }

resultadosL1 <- remover_outliers_zscore(df_Lula1, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreL1 <- resultadosL1$df_sem_outliers
df_com_outliers_ZscoreL1 <- resultadosL1$df_com_outliers
# Criando os dois boxplots
p1 <- ggplot(df_Lula1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreL1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreL1[,c(1,2,8)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaLula1, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreL1, "Lula1 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_Lula1 <- capture.output(summary(df_Lula1))
summary_sem_outliersL1 <- capture.output(summary(df_sem_outliers_ZscoreL1))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_Lula1, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersL1, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r Lula1, echo=TRUE}
mod_Lula1_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_ZscoreL1)
summary(mod_Lula1_UF)

mod_Lula1_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_ZscoreL1)
summary(mod_Lula1_Inter)

mod_Lula1_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_ZscoreL1)
summary(mod_Lula1_Imed)

mod_Lula1_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_ZscoreL1)
summary(mod_Lula1_Munic)

```

```{r Lula1Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_Lula1_UF)
plot_Inter <- plot_pizza_2D(mod_Lula1_Inter)
plot_Imed <- plot_pizza_2D(mod_Lula1_Imed)
plot_Munic <- plot_pizza_2D(mod_Lula1_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela Lula1 (2002 - 2005)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r Lula1Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_Lula1_UF, mod_Lula1_Inter, mod_Lula1_Imed, mod_Lula1_Munic)
names <- c("Lula1 UF", "Lula1 Inter", "Lula1 Imed", "Lula1 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r Lula1IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("Lula1 UF", "Lula1 Inter", "Lula1 Imed", "Lula1 Munic"),
  AIC = c(AIC(mod_Lula1_UF), AIC(mod_Lula1_Inter), AIC(mod_Lula1_Imed), AIC(mod_Lula1_Munic)),
  BIC = c(BIC(mod_Lula1_UF), BIC(mod_Lula1_Inter), BIC(mod_Lula1_Imed), BIC(mod_Lula1_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. Lula 1 (2002 - 2006)**

Na janela Lula1 (2002-2005), a Localizacao_UF (7,1%) destacou-se mais uma vez como a variável de localização mais influente no desempenho das cooperativas. Isso reforça o papel das condições estaduais, sugerindo que fatores regionais como políticas estaduais e economia local afetaram mais o desempenho das cooperativas em comparação aos níveis municipal e regional. No entanto, assim como nas outras janelas, a Unidade_de_Negocio continua sendo o fator predominante, superando a influência da localização.


---

---

# **Início da análise das Regressões da Janela FHC 2 (1998 - 2001)**
```{r df_FHC2, include=TRUE}


mod_FHC2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_FHC2)
```

<!-- #**Erro de Ajuste Singular:** -->
<!-- Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular'). -->

<!-- ##**Explicação:** -->
<!-- Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero.  -->

<!-- ##**Solução:** -->
<!-- Simplificar o modelo, removendo o nível **Ano**, adiante da existência de apenas 2 anos de dados. -->


<!-- mod_Dilma2 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic), data = df_Dilma2) -->
<!-- summary(mod_Dilma2) -->


```{r, echo=FALSE }

resultadosFHC2 <- remover_outliers_zscore(df_FHC2, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreFHC2 <- resultadosFHC2$df_sem_outliers
df_com_outliers_ZscoreFHC2 <- resultadosFHC2$df_com_outliers
# Criando os dois boxplots
p1 <- ggplot(df_FHC2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreFHC2, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreFHC2[,c(1,2,9)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaFHC2, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreFHC2, "FHC 2 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_FHC2 <- capture.output(summary(df_FHC2))
summary_sem_outliersFHC2 <- capture.output(summary(df_sem_outliers_ZscoreFHC2))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_FHC2, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersFHC2, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r FHC2, echo=TRUE}
mod_FHC2_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_ZscoreFHC2)
summary(mod_FHC2_UF)

mod_FHC2_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_ZscoreFHC2)
summary(mod_FHC2_Inter)

mod_FHC2_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_ZscoreFHC2)

mod_FHC2_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), 
                      data = df_sem_outliers_ZscoreFHC2, 
                      control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 10000)))
summary(mod_FHC2_Imed)

mod_FHC2_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_ZscoreFHC2)
summary(mod_FHC2_Munic)

```

```{r FHC2Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_FHC2_UF)
plot_Inter <- plot_pizza_2D(mod_FHC2_Inter)
plot_Imed <- plot_pizza_2D(mod_FHC2_Imed)
plot_Munic <- plot_pizza_2D(mod_FHC2_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela FHC2 (1998 - 2001)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r FHC2Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_FHC2_UF, mod_FHC2_Inter, mod_FHC2_Imed, mod_FHC2_Munic)
names <- c("FHC2 UF", "FHC2 Inter", "FHC2 Imed", "FHC2 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r FHC2IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("FHC2 UF", "FHC2 Inter", "FHC2 Imed", "FHC2 Munic"),
  AIC = c(AIC(mod_FHC2_UF), AIC(mod_FHC2_Inter), AIC(mod_FHC2_Imed), AIC(mod_FHC2_Munic)),
  BIC = c(BIC(mod_FHC2_UF), BIC(mod_FHC2_Inter), BIC(mod_FHC2_Imed), BIC(mod_FHC2_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. FHC 2 (1998 - 2001)**

Na janela FHC2 (1998-2001), a Localizacao_UF (2,8%) continua sendo a variável de localização mais relevante, embora sua influência seja significativamente menor em comparação à Unidade_de_Negocio. A importância da localização estadual pode estar associada a diferenças regionais nas políticas ou condições econômicas, mas sua magnitude é reduzida. Outros níveis de localização, como regional, intermediário e municipal, têm pouca relevância nesta janela temporal, o que sugere que, durante esse período, o desempenho das cooperativas foi mais fortemente determinado por fatores internos.

---

---

# **Início da análise das Regressões da Janela FHC 1 (1994 - 1997)**
```{r df_FHC1, include=TRUE}


mod_FHC1 <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_FHC1)
```

#**Erro de Ajuste Singular:**
Ao rodar a regressão acima, foi gerada a seguinte mensagem de aviso: boundary (singular) fit: see help('isSingular').

##**Explicação:**
Esse erro indica que o modelo encontrou um ajuste singular, o que significa que uma ou mais variâncias dos efeitos aleatórios estimados são muito próximas de zero.

##**Solução:**
Aplicar método de tratamento de outliers por sua capacidade de influenciar significativamente as estimativas de variância.


```{r, echo=FALSE }

resultadosFHC1 <- remover_outliers_zscore(df_FHC1, "SOBRAS_POR_ATIVO")
df_sem_outliers_ZscoreFHC1 <- resultadosFHC1$df_sem_outliers
df_com_outliers_ZscoreFHC1 <- resultadosFHC1$df_com_outliers
# Criando os dois boxplots
p1 <- ggplot(df_FHC1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Com Outliers")

p2 <- ggplot(df_sem_outliers_ZscoreFHC1, aes(y = SOBRAS_POR_ATIVO)) + 
  geom_boxplot() + 
  ggtitle("Sem Outliers *Z-Score")

# Exibindo os gráficos lado a lado
grid.arrange(p1, p2, ncol = 2)

```

#**Outlists identificados acima de 3 desvios padrão:**
```{r, echo=FALSE}
#Os outliers identificados como acima de 3 desvios padrão foram:
print(df_com_outliers_ZscoreFHC1[,c(1,2,9)])



```

##**Resumo estatístico da Janela Bolsonado após aplicação do Z-score:**
```{r descricao_estatisticaFHC1, echo=FALSE}
novo <- calcular_estatisticas(df_sem_outliers_ZscoreFHC1, "FHC 1 (Z-score)")

novo
```



```{r echo=FALSE, results='asis'}
# Criar o summary dos dois dataframes
summary_FHC1 <- capture.output(summary(df_FHC1))
summary_sem_outliersFHC1 <- capture.output(summary(df_sem_outliers_ZscoreFHC1))

# HTML para dividir a tela em duas colunas
cat('<div style="display: flex;">')
cat('<div style="flex: 1; padding-right: 10px;">')
cat('<h3>Estatísticas antes de remover outliers</h3>')
cat('<pre>', paste(summary_FHC1, collapse = "\n"), '</pre>')
cat('</div>')

cat('<div style="flex: 1; padding-left: 10px;">')
cat('<h3>Estatísticas após remover outliers (Z-score)</h3>')
cat('<pre>', paste(summary_sem_outliersFHC1, collapse = "\n"), '</pre>')
cat('</div>')
cat('</div>')

```



---

### Rodando a regressão usando **Modelos Lineares Mistos** com 3 níveis (1 - Ano; 2 - Unidade de Negócio; 3 - Localização. 

##Estão sendo utilizadas as seguintes variáveis de localização: **Estado, Região Intermediária, Região Imediata e Município**. 

```{r FHC1, echo=TRUE}
mod_FHC1_UF <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_UF) + (1 | Ano), data = df_sem_outliers_ZscoreFHC1)
summary(mod_FHC1_UF)

mod_FHC1_Inter <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Inter) + (1 | Ano), data = df_sem_outliers_ZscoreFHC1)
summary(mod_FHC1_Inter)

mod_FHC1_Imed <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_Imed) + (1 | Ano), data = df_sem_outliers_ZscoreFHC1)
summary(mod_FHC1_Imed)

mod_FHC1_Munic <- lmer(SOBRAS_POR_ATIVO ~ (1 | Unidade_de_Negocio) + (1 | Localizacao_munic) + (1 | Ano), data = df_sem_outliers_ZscoreFHC1)
summary(mod_FHC1_Munic)

```

```{r FHC1Plot, echo=FALSE}
# Gerar gráficos de pizza para cada modelo
plot_UF <- plot_pizza_2D(mod_FHC1_UF)
plot_Inter <- plot_pizza_2D(mod_FHC1_Inter)
plot_Imed <- plot_pizza_2D(mod_FHC1_Imed)
plot_Munic <- plot_pizza_2D(mod_FHC1_Munic)

# Ajustar espaçamento para melhor utilização da área da tela
grid.arrange(
  plot_UF, plot_Inter,
  plot_Imed, plot_Munic,
  ncol = 2,
  widths = c(1, 1),
  heights = c(1, 1),
  top = "Comparação dos Modelos da Janela FHC1 (1995 - 2008)"
)

```


## **Componentes de variância lado a lado para análise quantitativa entre os modelos**.
```{r FHC1Models, echo=FALSE}
# Executar a comparação com os 4 modelos
models <- list(mod_FHC1_UF, mod_FHC1_Inter, mod_FHC1_Imed, mod_FHC1_Munic)
names <- c("FHC1 UF", "FHC1 Inter", "FHC1 Imed", "FHC1 Munic")

comparison_table <- compare_variances(models, names)
comparison_table
```


## **Comparando AIC e BIC para os modelos**
```{r FHC1IAC, echo=FALSE}

model_comparison <- data.frame(
  Model = c("FHC1 UF", "FHC1 Inter", "FHC1 Imed", "FHC1 Munic"),
  AIC = c(AIC(mod_FHC1_UF), AIC(mod_FHC1_Inter), AIC(mod_FHC1_Imed), AIC(mod_FHC1_Munic)),
  BIC = c(BIC(mod_FHC1_UF), BIC(mod_FHC1_Inter), BIC(mod_FHC1_Imed), BIC(mod_FHC1_Munic))
)
model_comparison

```
## **Resultado da Decomposição de Variância do Desempenho da janela temporal Gov. FHC 1 (1995 - 1998)**

Durante a janela FHC1 (1995-1998), a Localização_Imed (12,4%) se destacou como a variável de localização mais relevante, sugerindo que a localização intermediária teve um impacto mais significativo no desempenho das cooperativas de crédito. A influência da localização intermediária pode estar relacionada a fatores regionais específicos ou políticas locais que afetaram a operação das cooperativas nesse nível.

# **Tabela Geral das Regressões**

```{r, results='asis', echo=FALSE}
library(DT)

# Carregar os dados da tabela
tabela_janelas <- read.csv("c:/Aula3/docs/Tabela_Janelas_Temporais.csv")

# Criar uma tabela interativa com rolagem horizontal
datatable(tabela_janelas, options = list(scrollX = TRUE), 
          caption = "Tabela Comparativa das Janelas Temporais")
```

